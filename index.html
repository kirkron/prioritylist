<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Itemeaser ðŸ˜Œ</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #121212;
            color: #ffffff;
        }
        .container {
            max-width: 600px;
            width: 100%;
        }
        .hidden {
            display: none;
        }
        .centered {
            text-align: center;
        }
        .input-field input[type=text] {
            color: #ffffff;
        }
        .input-field input[type=text]:focus + label {
            color: #ffffff;
        }
        .input-field .prefix.active {
            color: #ffffff;
        }
        .input-field input[type=text]:focus {
            border-bottom: 1px solid #ffffff;
            box-shadow: 0 1px 0 0 #ffffff;
        }
        .collection .collection-item {
            color: #ffffff;
            background-color: transparent;
            position: relative;
        }
        .collection-item .btn-flat {
            color: #ffffff;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 24px;
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
        }
        .btn, .btn:hover, .btn:focus {
            background-color: #ff5722;
        }
        .card {
            background-color: #333333;
        }
        .bar {
            height: 10px;
            width: 0;
            position: absolute;
            bottom: 0;
            left: 0;
            z-index: 0;
        }
        .list-item-wrapper {
            position: relative;
            padding: 10px;
        }
        .action-buttons {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .completed-task {
            text-decoration: line-through;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="centered">Itemeaser ðŸ˜Œ</h1>
        <p class="centered" id="tagline">Struggling to decide between different options? Overwhelmed by all of the possible outcomes? Don't worry. Itemeaser helps you. Just enter all of your options and Itemeaser will guide you through the process of ordering them.</p>
        <div id="step-1">
            <div class="input-field">
                <input type="text" id="task-input" placeholder="Enter an item to prioritize." onkeypress="handleKeyPress(event)">
                <label for="task-input">Item</label>
            </div>
            <ul class="collection" id="task-list"></ul>
            <div class="action-buttons">
                <button class="btn waves-effect waves-light grey darken-3" onclick="resetTasks()">Reset</button>
                <button class="btn waves-effect waves-light blue lighten-2" onclick="shareTasks()">Share List</button>
                
                <button class="btn waves-effect waves-light" onclick="addTask3()">Add Item</button>
                <button class="btn waves-effect waves-light red lighten-2" onclick="confirmTasks()">Compare Items</button>
            </div>
        </div>
        <div id="step-2" class="hidden">
            <h2 class="centered">Compare Items</h2>
            <p class="centered">Pick an Item.</p>
            <div class="centered">
                <button class="btn waves-effect waves-light" id="left-button" onclick="chooseTask('left')"></button>
                <button class="btn waves-effect waves-light" id="right-button" onclick="chooseTask('right')"></button>
            </div>
        </div>
        <div id="step-3" class="hidden">
            <h2 class="centered">Results</h2>
            <div class="row">
                <div class="col s12">
                    <div class="card">
                        <div class="card-content">
                            <span class="card-title">Ordered Items</span>
                            <ul class="collection" id="ordered-tasks"></ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="input-field">
                <input type="text" id="task-input-3" placeholder="Enter an item to prioritize." onkeypress="handleKeyPress3(event)">
                <label for="task-input-3">Item</label>
            </div>
            <ul class="collection" id="task-list-3"></ul>
            <div class="action-buttons">
                <button class="btn waves-effect waves-light grey darken-3" onclick="resetTasks()">Reset</button>
                <button class="btn waves-effect waves-light blue lighten-2" onclick="shareTasks()">Share List</button>
                
                <button class="btn waves-effect waves-light" onclick="addTask3()">Add Item</button>
                <button class="btn waves-effect waves-light red lighten-2" onclick="confirmTasks()">Compare Items</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script>
        let tasks = [];
        let comparisons = [];
        let comparisonIndex = 0;
        let taskColors = [];
        let completedTasks = new Set();

        function loadFromURL() {
            const params = new URLSearchParams(window.location.search);
            if (params.has('tasks') && params.has('colors') && params.has('completed')) {
                tasks = JSON.parse(decodeURIComponent(params.get('tasks')));
                taskColors = JSON.parse(decodeURIComponent(params.get('colors')));
                completedTasks = new Set(JSON.parse(decodeURIComponent(params.get('completed'))));
                if (params.has('comparisons')) {
                    comparisons = JSON.parse(decodeURIComponent(params.get('comparisons')));
                }
                updateTaskList();
                updateTaskList3();
                if (tasks.length > 1 && comparisons.length > 0) {
                    calculatePrioritization();
                    document.getElementById('step-1').classList.add('hidden');
                    document.getElementById('step-3').classList.remove('hidden');
                    document.getElementById('tagline').classList.add('hidden');
                }
            }
        }

        function updateURL() {
            const params = new URLSearchParams({
                tasks: encodeURIComponent(JSON.stringify(tasks)),
                colors: encodeURIComponent(JSON.stringify(taskColors)),
                completed: encodeURIComponent(JSON.stringify([...completedTasks])),
                comparisons: encodeURIComponent(JSON.stringify(comparisons))
            });
            history.replaceState(null, '', '?' + params.toString());
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                addTask();
            }
        }

        function handleKeyPress3(event) {
            if (event.key === 'Enter') {
                addTask3();
            }
        }

        function addTask() {
            const taskInput = document.getElementById('task-input');
            const task = taskInput.value.trim();
            if (task) {
                tasks.push(task);
                taskColors.push(generateColor(tasks.length - 1));
                taskInput.value = '';
                updateTaskList();
                updateTaskList3();
                updateURL();
            }
        }

        function addTask3() {
            const taskInput = document.getElementById('task-input-3');
            const task = taskInput.value.trim();
            if (task) {
                tasks.push(task);
                taskColors.push(generateColor(tasks.length - 1));
                taskInput.value = '';
                updateTaskList();
                updateTaskList3();
                updateURL();
            }
        }

        function updateTaskList() {
            const taskList = document.getElementById('task-list');
            taskList.innerHTML = '';
            tasks.forEach((task, index) => {
                const li = document.createElement('li');
                li.className = 'collection-item';
                li.style.backgroundColor = taskColors[index];
                li.innerHTML = `
                    ${task}
                    <button class="btn-flat" onclick="removeTask(${index})">&#128465;</button>
                `;
                taskList.appendChild(li);
            });
        }

        function updateTaskList3() {
            const taskList3 = document.getElementById('task-list-3');
            taskList3.innerHTML = '';
            tasks.forEach((task, index) => {
                const li = document.createElement('li');
                li.className = 'collection-item';
                li.style.backgroundColor = taskColors[index];
                li.innerHTML = `
                    ${task}
                    <button class="btn-flat" onclick="removeTask(${index})">&#128465;</button>
                `;
                taskList3.appendChild(li);
            });
        }

        function generateColor(index) {
            const colors = [
                '#ff8a80', '#ff5252', '#ff1744', '#d50000',
                '#ff80ab', '#ff4081', '#f50057', '#c51162',
                '#ea80fc', '#e040fb', '#d500f9', '#aa00ff',
                '#b388ff', '#7c4dff', '#651fff', '#6200ea'
            ];
            return colors[index % colors.length];
        }

        function confirmTasks() {
            if (tasks.length > 1) {
                document.getElementById('step-1').classList.add('hidden');
                document.getElementById('step-3').classList.add('hidden');                
                document.getElementById('tagline').classList.add('hidden');

                prepareComparisons();
                document.getElementById('step-2').classList.remove('hidden');
            } else {
                alert('Please add at least two tasks.');
            }
        }

        function prepareComparisons() {
            comparisons = [];
            for (let i = 0; i < tasks.length; i++) {
                for (let j = i + 1; j < tasks.length; j++) {
                    comparisons.push({ left: i, right: j });
                }
            }
            shuffleArray(comparisons);
            comparisonIndex = 0;
            showComparison();
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function showComparison() {
            if (comparisonIndex < comparisons.length) {
                const comp = comparisons[comparisonIndex];
                const leftButton = document.getElementById('left-button');
                const rightButton = document.getElementById('right-button');
                leftButton.textContent = tasks[comp.left];
                rightButton.textContent = tasks[comp.right];
                leftButton.style.backgroundColor = taskColors[comp.left];
                rightButton.style.backgroundColor = taskColors[comp.right];
            } else {
                document.getElementById('step-2').classList.add('hidden');
                calculatePrioritization();
                document.getElementById('step-3').classList.remove('hidden');
            }
        }

        function chooseTask(choice) {
            const comp = comparisons[comparisonIndex];
            if (choice === 'left') {
                comp.winner = comp.left;
            } else {
                comp.winner = comp.right;
            }
            comparisonIndex++;
            updateURL();
            showComparison();
        }

        function calculatePrioritization() {
            const scores = new Array(tasks.length).fill(0);
            comparisons.forEach(comp => {
                if (comp.winner !== undefined) {
                    scores[comp.winner]++;
                }
            });
            const orderedTasks = tasks.map((task, index) => ({ task, score: scores[index], color: taskColors[index] }))
                .sort((a, b) => b.score - a.score);
            displayResults(orderedTasks);
        }

        function displayResults(orderedTasks) {
            const orderedList = document.getElementById('ordered-tasks');
            orderedList.innerHTML = '';
            const maxScore = Math.max(...orderedTasks.map(task => task.score));
            orderedTasks.forEach(({ task, score, color }, index) => {
                const li = document.createElement('li');
                li.className = 'collection-item list-item-wrapper';
                const checkboxId = `checkbox-${index}`;
                li.innerHTML = `
                    <label>
                        <input type="checkbox" id="${checkboxId}" ${completedTasks.has(task) ? 'checked' : ''} onclick="toggleCompletion('${task}')">
                        <span class="${completedTasks.has(task) ? 'completed-task' : ''}">${task} (Score: ${score})</span>
                    </label>
                    <div class="bar" style="width: ${(score / maxScore) * 100}%; background-color: ${color};"></div>
                    <button class="btn-flat" onclick="removeResult(${index})">&#128465;</button>
                `;
                orderedList.appendChild(li);
            });
            updateURL(); // Update URL after displaying results
        }

        function toggleCompletion(task) {
            if (completedTasks.has(task)) {
                completedTasks.delete(task);
            } else {
                completedTasks.add(task);
            }
            displayResults(calculateOrderedTasks());
        }

        function removeTask(index) {
            tasks.splice(index, 1);
            taskColors.splice(index, 1);
            completedTasks = new Set([...completedTasks].filter(task => tasks.includes(task)));
            updateTaskList();
            updateTaskList3();
            updateURL(); // Update URL after removing a task
        }

        function removeResult(index) {
            const orderedTasks = document.getElementById('ordered-tasks').children;
            if (index >= 0 && index < orderedTasks.length) {
                const task = orderedTasks[index];
                const taskName = task.textContent.split(' (')[0].trim();
                const taskIndex = tasks.indexOf(taskName);
                if (taskIndex > -1) {
                    tasks.splice(taskIndex, 1);
                    taskColors.splice(taskIndex, 1);
                    completedTasks = new Set([...completedTasks].filter(task => tasks.includes(task)));
                    updateTaskList();
                    updateTaskList3();
                    displayResults(calculateOrderedTasks());
                    updateURL(); // Update URL after removing a result
                }
            }
        }

        function calculateOrderedTasks() {
            const scores = new Array(tasks.length).fill(0);
            comparisons.forEach(comp => {
                if (comp.winner !== undefined) {
                    scores[comp.winner]++;
                }
            });
            return tasks.map((task, index) => ({ task, score: scores[index], color: taskColors[index] }))
                .sort((a, b) => b.score - a.score);
        }

        function shareTasks() {
            const shareUrl = window.location.href;
            if (navigator.share) {
                navigator.share({
                    title: 'Task Prioritization',
                    text: 'Check out these tasks:',
                    url: shareUrl
                }).catch(error => console.error('Error sharing:', error));
            } else if (navigator.clipboard) {
                navigator.clipboard.writeText(shareUrl).then(() => {
                    alert('URL copied to clipboard!');
                }).catch(error => console.error('Error copying URL:', error));
            }
        }

        function resetTasks() {
            tasks = [];
            comparisons = [];
            comparisonIndex = 0;
            taskColors = [];
            completedTasks = new Set();
            updateTaskList();
            updateTaskList3();
            document.getElementById('step-1').classList.remove('hidden');
            document.getElementById('tagline').classList.add('hidden');
            document.getElementById('step-2').classList.add('hidden');
            document.getElementById('step-3').classList.add('hidden');
            updateURL();
        }

        // Initialize the app
        window.onload = loadFromURL;
    </script>
</body>
</html>
